# text_task_service.md.txt

Advanced Task: Create a bash script, run it as a systemd service, and monitor it

Goal

You will create a simple “robot application” bash script that logs heartbeats and simulates a running robot component. Then you will create a systemd template service so you can run it as robot-app@<username>. Finally you will start it, enable autostart, and monitor it using systemctl and journalctl.

Before you start

You need a user that will run the service. In this guide we use the user name “robotop”.
You also need sudo privileges on the machine.

Step 1: Confirm the user and home directory exist

Check that the user exists and note the home directory path systemd will use.

Run:
id robotop
getent passwd robotop

If the user does not exist, create it:
sudo adduser robotop

If you want this user to be able to use sudo (optional, depends on your setup):
sudo usermod -aG sudo robotop

Step 2: Create the folders for scripts and logs

We place scripts in /home/robotop/robotics/scripts and logs in /home/robotop/robotics/logs.

Run:
sudo -u robotop mkdir -p /home/robotop/robotics/{scripts,logs}

Step 3: Create the example robot bash script

Create the script file in the scripts directory. This script will:
- define variables
- use an if statement to validate input
- run a loop that prints a heartbeat
- write to a log file and also print to stdout (so journalctl can capture it)

You will create it using a heredoc (cat).

Run:
sudo -u robotop bash -lc 'cat > /home/robotop/robotics/scripts/robot_app.sh <<'"'"'EOF'"'"'
#!/usr/bin/env bash
set -euo pipefail

NAME="${1:-robot-app}"
MODE="${2:-normal}"       # normal or fast
INTERVAL="${3:-2}"         # seconds
LOG_DIR="$HOME/robotics/logs"
LOG_FILE="$LOG_DIR/robot_app.log"

mkdir -p "$LOG_DIR"

echo "[$(date -Is)] starting: NAME=$NAME MODE=$MODE INTERVAL=$INTERVAL" | tee -a "$LOG_FILE"

if [[ "$MODE" != "normal" && "$MODE" != "fast" ]]; then
  echo "[$(date -Is)] ERROR: MODE must be 'normal' or 'fast'" | tee -a "$LOG_FILE"
  exit 1
fi

if ! [[ "$INTERVAL" =~ ^[0-9]+$ ]]; then
  echo "[$(date -Is)] ERROR: INTERVAL must be an integer seconds value" | tee -a "$LOG_FILE"
  exit 1
fi

count=0
while true; do
  count=$((count + 1))

  if (( count % 5 == 0 )); then
    echo "[$(date -Is)] heartbeat $count: status=OK (periodic-check)" | tee -a "$LOG_FILE"
  else
    echo "[$(date -Is)] heartbeat $count: status=OK" | tee -a "$LOG_FILE"
  fi

  if [[ "$MODE" == "fast" ]]; then
    sleep 0.5
  else
    sleep "$INTERVAL"
  fi
done
EOF'

Step 4: Make the script executable

Systemd must be able to execute it.

Run:
sudo chmod +x /home/robotop/robotics/scripts/robot_app.sh
sudo -u robotop /home/robotop/robotics/scripts/robot_app.sh --help 2>/dev/null || true

Quick test (run for a few seconds, then Ctrl+C):
sudo -u robotop /home/robotop/robotics/scripts/robot_app.sh demo normal 1

Step 5: Install the systemd template service file

The service is a template. The file name must contain “@.service” or systemd will not find robot-app@robotop.

Create:
sudo nano /etc/systemd/system/robot-app@.service

Paste the content from linux_service_template.service (provided separately).

Step 6: Reload systemd to pick up the new unit file

Run:
sudo systemctl daemon-reload

Step 7: Start the service instance

Run:
sudo systemctl start robot-app@robotop
sudo systemctl status robot-app@robotop --no-pager

If it fails, read the logs:
sudo journalctl -u robot-app@robotop -n 100 --no-pager

Step 8: Enable autostart on boot

Run:
sudo systemctl enable robot-app@robotop
sudo systemctl is-enabled robot-app@robotop

Step 9: Monitor the service logs (live)

Run:
sudo journalctl -u robot-app@robotop -f

Step 10: Stop, restart, and verify it recovers

Stop:
sudo systemctl stop robot-app@robotop

Start again:
sudo systemctl start robot-app@robotop

Restart:
sudo systemctl restart robot-app@robotop

Step 11: Verify the script log file is being written

Run:
sudo -u robotop tail -n 20 /home/robotop/robotics/logs/robot_app.log

Notes about common failures

If systemctl says “Unit robot-app@robotop.service not found”, your unit file name is wrong. It must be robot-app@.service for a template.
If status shows “ExecStart=… no such file”, the script path is wrong or the user’s home directory is not /home/<user>.
If the script runs fine manually but fails as a service, you likely rely on environment variables from your interactive shell that systemd does not load. Put required Environment= lines into the unit file.

End of task.

